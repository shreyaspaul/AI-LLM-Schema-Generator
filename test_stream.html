<!DOCTYPE html>
<html>
<head>
	<title>Schema Generator - Progress Test</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			max-width: 800px;
			margin: 50px auto;
			padding: 20px;
		}
		#progress {
			background: #f5f5f5;
			border: 1px solid #ddd;
			padding: 20px;
			border-radius: 5px;
			max-height: 400px;
			overflow-y: auto;
			margin-top: 20px;
		}
		.message {
			padding: 5px;
			margin: 3px 0;
		}
		.info { color: #0066cc; }
		.warn { color: #ff9900; }
		.error { color: #cc0000; }
		button {
			padding: 10px 20px;
			font-size: 16px;
			cursor: pointer;
		}
		input {
			padding: 8px;
			width: 300px;
			margin-right: 10px;
		}
	</style>
</head>
<body>
	<h1>AI Schema Generator - Streaming Test</h1>
	<div>
		<input type="text" id="url" placeholder="https://example.com" value="https://www.webless.ai">
		<input type="number" id="maxPages" placeholder="Max pages" value="3" min="1" max="100">
		<button onclick="startCrawl()">Start Crawl</button>
	</div>
	<div id="progress"></div>
	<div id="status"></div>

	<script>
		function startCrawl() {
			const url = document.getElementById('url').value;
			const maxPages = parseInt(document.getElementById('maxPages').value) || 3;
			const progressDiv = document.getElementById('progress');
			const statusDiv = document.getElementById('status');
			
			progressDiv.innerHTML = '';
			statusDiv.innerHTML = 'Connecting...';
			
			fetch('http://localhost:8000/crawl/stream', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					base_url: url,
					max_pages: maxPages
				})
			})
			.then(response => {
				const reader = response.body.getReader();
				const decoder = new TextDecoder();
				let buffer = '';
				
				function readChunk() {
					reader.read().then(({ done, value }) => {
						if (done) {
							statusDiv.innerHTML = '<strong>Stream ended</strong>';
							return;
						}
						
						buffer += decoder.decode(value, { stream: true });
						const lines = buffer.split('\n\n');
						buffer = lines.pop(); // Keep incomplete line in buffer
						
						lines.forEach(line => {
							if (line.startsWith('data: ')) {
								try {
									const data = JSON.parse(line.substring(6));
									
									if (data.type === 'zip') {
										// Download ZIP file
										const link = document.createElement('a');
										link.href = 'data:application/zip;base64,' + data.data;
										link.download = data.filename;
										link.click();
										statusDiv.innerHTML = `<strong style="color: green;">âœ“ Complete! Downloaded: ${data.filename}</strong>`;
									} else if (data.type === 'complete') {
										statusDiv.innerHTML = '<strong>Creating ZIP file...</strong>';
									} else if (data.type === 'error') {
										statusDiv.innerHTML = `<strong style="color: red;">Error: ${data.message}</strong>`;
									} else {
										// Progress message
										const msgDiv = document.createElement('div');
										msgDiv.className = `message ${data.type || 'info'}`;
										msgDiv.textContent = `[${data.type || 'info'}] ${data.message}`;
										progressDiv.appendChild(msgDiv);
										progressDiv.scrollTop = progressDiv.scrollHeight;
									}
								} catch (e) {
									console.error('Parse error:', e, line);
								}
							}
						});
						
						readChunk();
					});
				}
				
				readChunk();
			})
			.catch(error => {
				statusDiv.innerHTML = `<strong style="color: red;">Error: ${error.message}</strong>`;
			});
		}
	</script>
</body>
</html>

